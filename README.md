# LINE Order Bot with Credit Management

A comprehensive LINE chatbot system with credit management, slip verification, and admin dashboard built with Next.js 14, TypeScript, and Neon PostgreSQL.

## Features

### LINE Bot Features
- ğŸ’° **Credit Balance Check** - Users can check their credit balance and spending limits
- ğŸ“‹ **Transaction History** - View purchase and topup history
- ğŸ **Token Redemption** - Redeem credit tokens generated by admins
- ğŸ›’ **Product Purchase** - Buy products with credit
- ğŸ’³ **Automatic Slip Verification** - QR code scanning and automatic verification via SlipOK API
- âš™ï¸ **Credit Tier System** - Automatic credit limit upgrades based on spending

### Admin Dashboard Features
- ğŸ‘¥ **User Management** - View all LINE users and their credit balances
- ğŸ“Š **Transaction Monitoring** - Track all purchases and topups
- âœ… **Slip Approval** - Manually approve/reject slips that fail automatic verification
- ğŸ“¦ **Product Management** - Full CRUD for products and inventory
- ğŸ‘¨â€ğŸ’¼ **Admin Management** - Add multiple admin users
- ğŸ” **Secure Authentication** - NextAuth.js with bcrypt password hashing

## Tech Stack

- **Framework**: Next.js 14 (App Router)
- **Language**: TypeScript
- **Database**: Neon PostgreSQL
- **ORM**: Drizzle ORM
- **Authentication**: NextAuth.js
- **UI**: Tailwind CSS, shadcn/ui
- **Font**: IBM Plex Sans Thai
- **LINE Bot**: @line/bot-sdk
- **Slip Verification**: SlipOK API
- **Storage**: Cloudflare R2
- **Notifications**: react-hot-toast

## Prerequisites

- Node.js 18+ and npm
- Neon PostgreSQL database
- LINE Messaging API account
- SlipOK API credentials
- Cloudflare R2 account (for slip image storage)

## Installation

### 1. Clone the repository

```bash
git clone https://github.com/Pranakorn-Group/line-order-bot.git
cd line-order-bot
```

### 2. Install dependencies

```bash
npm install
```

### 3. Setup environment variables

Copy `.env.example` to `.env.local` and fill in your credentials:

```bash
cp .env.example .env.local
```

Required environment variables:

```env
# Database
DATABASE_URL=postgresql://user:password@host/database?sslmode=require

# NextAuth
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=your-secret-key-here

# LINE Bot
LINE_CHANNEL_SECRET=your-line-channel-secret
LINE_CHANNEL_ACCESS_TOKEN=your-line-channel-access-token

# SlipOK API (https://suba.rdcw.co.th)
SLIPOK_CLIENT_ID=4b576438bdbb4b829a95c55e46818077
SLIPOK_CLIENT_SECRET=vYDI3zUf_TGNZTsOwM4fW

# SlipOK Check Conditions (Optional - for automatic validation)
SLIPOK_CHECK_DUPLICATE=true
SLIPOK_RECEIVER_ACCOUNT_TYPE=01006
SLIPOK_RECEIVER_NAME_TH=à¸šà¸¸à¸à¸¢à¸¤à¸—à¸˜à¸´à¹Œ
SLIPOK_RECEIVER_NAME_EN=BOONYARIT

# Expected Bank Receiver Name (for manual verification fallback)
SLIP_RECEIVER_NAME_EN=BOONYARIT S

# Cloudflare R2
R2_ACCOUNT_ID=your-r2-account-id
R2_ACCESS_KEY_ID=your-r2-access-key-id
R2_SECRET_ACCESS_KEY=your-r2-secret-access-key
R2_BUCKET_NAME=line-bot-slips
R2_PUBLIC_URL=https://your-bucket.r2.dev
```

**SlipOK Check Conditions Explained:**
- `SLIPOK_CHECK_DUPLICATE=true` - Automatically reject duplicate slips (same transaction reference)
- `SLIPOK_RECEIVER_ACCOUNT_TYPE=01006` - Verify receiver account type (01006 for Bangkok Bank savings account)
- `SLIPOK_RECEIVER_NAME_TH=à¸šà¸¸à¸à¸¢à¸¤à¸—à¸˜à¸´à¹Œ` - Verify Thai name on receiver account
- `SLIPOK_RECEIVER_NAME_EN=BOONYARIT` - Verify English name on receiver account

These conditions are sent to SlipOK API in the `checkCondition` payload for server-side validation.

### 4. Generate database migrations

```bash
npm run db:generate
```

### 5. Run migrations

```bash
npm run db:migrate
```

### 6. Seed initial admin user

Create a script to add your first admin:

```bash
node scripts/create-admin.js
```

Or use Drizzle Studio to manually insert:

```bash
npm run db:studio
```

### 7. Run the development server

```bash
npm run dev
```

Open [http://localhost:3000](http://localhost:3000) in your browser.

## Setup LINE Bot Webhook

1. Go to [LINE Developers Console](https://developers.line.biz/)
2. Create or select your Messaging API channel
3. In the Messaging API settings, set the webhook URL to:
   ```
   https://your-domain.com/api/webhook
   ```
4. Enable "Use webhook" and verify the webhook
5. Disable auto-reply messages if needed

## Usage

### LINE Bot Commands

Users can interact with the bot using these commands:

- `/balance` or `à¹€à¸Šà¹‡à¸„à¹€à¸„à¸£à¸”à¸´à¸•` - Check credit balance
- `/history` or `à¸›à¸£à¸°à¸§à¸±à¸•à¸´` - View transaction history
- `/products` or `à¸ªà¸´à¸™à¸„à¹‰à¸²` - View product catalog
- `/buy {product_id}` - Purchase a product (e.g., `/buy 1`)
- `/load {token}` - Redeem credit token
- **Send slip image** - Automatic topup via QR code verification
- `/help` or `à¸Šà¹ˆà¸§à¸¢à¹€à¸«à¸¥à¸·à¸­` - Show all commands

### Admin Dashboard

Access the dashboard at `/login`:

1. **Users Page** - View all users, their credits, and spending limits
2. **Transactions** - Monitor all purchases and topups
3. **Slips** - Approve/reject pending slip verifications
4. **Products** - Add, edit, or remove products
5. **Admins** - Manage admin users

### Credit System

#### How It Works

1. **Initial Credit**: New users start with 0 credit and 0 minimum credit
2. **Token Redemption**: Admins generate tokens that users can redeem for credit
3. **Slip Verification**: Users send slip images for automatic credit topup
4. **Purchases**: Users buy products, credit is deducted
5. **Minimum Credit**: Acts as a credit limit (users can't go below this)
6. **Credit Tiers**: Based on total spending, users automatically get better credit limits

#### Admin Token Generation

Admins need to generate credit tokens. You can create an API endpoint or script:

```typescript
// Example: Generate a token worth 1000 baht with -500 minimum credit
const token = await db.insert(creditTokens).values({
  token: generateRandomToken(), // e.g., "ABC123"
  creditAmount: "1000",
  minimumCreditBonus: "-500", // User can go -500 baht
  createdByAdminId: adminId,
  expiresAt: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000), // 30 days
});
```

#### Credit Tier Setup

Create credit tiers in the database:

```sql
INSERT INTO credit_tiers (min_spend, credit_bonus, description, active)
VALUES
  (0, 0, 'New user - no credit limit', true),
  (1000, -500, 'Bronze - can go -500 baht', true),
  (5000, -1000, 'Silver - can go -1000 baht', true),
  (10000, -2000, 'Gold - can go -2000 baht', true);
```

## Project Structure

```
line-order-bot/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ (dashboard)/           # Dashboard pages
â”‚   â”‚   â”œâ”€â”€ layout.tsx         # Protected layout with navigation
â”‚   â”‚   â”œâ”€â”€ page.tsx           # Users list
â”‚   â”‚   â”œâ”€â”€ transactions/      # Transaction history
â”‚   â”‚   â”œâ”€â”€ slips/             # Slip approval
â”‚   â”‚   â”œâ”€â”€ products/          # Product management
â”‚   â”‚   â””â”€â”€ admins/            # Admin management
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ auth/              # NextAuth endpoints
â”‚   â”‚   â”œâ”€â”€ webhook/           # LINE bot webhook
â”‚   â”‚   â”œâ”€â”€ slips/             # Slip approval APIs
â”‚   â”‚   â””â”€â”€ products/          # Product CRUD APIs
â”‚   â”œâ”€â”€ login/                 # Login page
â”‚   â”œâ”€â”€ layout.tsx             # Root layout
â”‚   â””â”€â”€ globals.css            # Global styles
â”œâ”€â”€ components/
â”‚   â””â”€â”€ ui/                    # shadcn components
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ db/                    # Database schema and client
â”‚   â”œâ”€â”€ line/                  # LINE bot handlers
â”‚   â”‚   â”œâ”€â”€ client.ts          # LINE client
â”‚   â”‚   â”œâ”€â”€ handlers.ts        # Message handlers
â”‚   â”‚   â”œâ”€â”€ user-service.ts    # User operations
â”‚   â”‚   â””â”€â”€ commands/          # Bot commands
â”‚   â”œâ”€â”€ slipverify/            # Slip verification
â”‚   â”‚   â”œâ”€â”€ client.ts          # SlipOK API client
â”‚   â”‚   â””â”€â”€ qr-extract.ts      # QR code extraction
â”‚   â”œâ”€â”€ r2/                    # Cloudflare R2 client
â”‚   â”œâ”€â”€ auth.ts                # NextAuth config
â”‚   â””â”€â”€ utils.ts               # Utility functions
â”œâ”€â”€ drizzle/                   # Migration files
â”œâ”€â”€ .env.example               # Environment variables template
â”œâ”€â”€ drizzle.config.ts          # Drizzle configuration
â”œâ”€â”€ tailwind.config.ts         # Tailwind configuration
â””â”€â”€ package.json               # Dependencies

```

## Database Schema

### Tables

- **admins** - Admin users with hashed passwords
- **users** - LINE users with credit balances
- **products** - Product catalog with stock
- **transactions** - All credit transactions
- **slips** - Bank slip verifications
- **credit_tokens** - Redeemable credit tokens
- **credit_tiers** - Spending-based credit limits

## API Endpoints

### LINE Webhook
- `POST /api/webhook` - LINE bot webhook

### Authentication
- `POST /api/auth/[...nextauth]` - NextAuth endpoints

### Slips
- `GET /api/slips/pending` - Get pending slips
- `POST /api/slips/[id]/approve` - Approve slip
- `POST /api/slips/[id]/reject` - Reject slip

### Products
- `GET /api/products` - Get all products
- `POST /api/products` - Create product
- `PUT /api/products/[id]` - Update product
- `DELETE /api/products/[id]` - Delete product

### Admins
- `GET /api/admins` - Get all admins
- `POST /api/admins` - Create admin

## Development

### Run development server
```bash
npm run dev
```

### Build for production
```bash
npm run build
npm start
```

### Database commands
```bash
npm run db:generate    # Generate migrations
npm run db:migrate     # Run migrations
npm run db:studio      # Open Drizzle Studio
```

## Deployment

### Vercel (Recommended)

1. Push your code to GitHub
2. Import project in Vercel
3. Add environment variables
4. Deploy

### Other Platforms

Make sure to:
1. Set all environment variables
2. Run database migrations
3. Configure webhook URL in LINE Console

## Security Notes

- Passwords are hashed with bcrypt (12 rounds)
- LINE webhook signature validation
- NextAuth.js for secure sessions
- Environment variables for sensitive data
- SQL injection protection with Drizzle ORM

## Support

For issues or questions, please open an issue on GitHub.

## License

MIT

## Credits

Built with â¤ï¸ using Next.js, TypeScript, and LINE Messaging API
